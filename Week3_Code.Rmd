---
title: "Week 3 Code and Exercises"
author: "SOC 456/503 & POL S 528"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
subtitle: Data, Data, Data
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The code for Week 3 shows us how to read-in and work with different types of datasets. 

# 2. Managing Data

# Reading in data 

## Google Drive

```{r}
install.packages("googledrive")
install.packages("RCurl")
library(googledrive)
library(RCurl)

gdown https://drive.google.com/uc?id=file_id


#https://drive.google.com/drive/folders/1wnhFFY-06YaAyrAgqFrsTHc3aG4SqosS?usp=sharing

temp <- tempfile(fileext = ".zip")
dl <- drive_download(
  as_id("https://drive.google.com/file/d/1ldHPmmwCtALjqA3e-l7QvF5UKwwbzFzW/view?usp=sharing"), path = temp, overwrite = TRUE)
out <- unzip(temp, exdir = tempdir())
d1 <- read.csv("cpss_series2.csv")

link <- "https://drive.google.com/file/d/19jDLGnHcTctYhNvFYzC_Q-YW_xl17N98/view?usp=sharing"
url <- getURL( link )
con <- textConnection( url )
d2<- read.csv( con )

```


## Comma delimited (.csv) file

- Use `read.csv` to read-in .csv files
- Make sure to change the file path on your computer to where your data are saved!!!!! 

```{r}
## You will need to change the file path on your computer to where your data are saved!!!!!

d1 <- read.csv("/Users/maroto/Dropbox/ Teaching/ SOC 456/ SOC 456 - FALL 20/ Lectures/ Week 3/ Data/cpss_series2.csv", header=TRUE)

d1 <- drive_get("https://drive.google.com/file/d/19jDLGnHcTctYhNvFYzC_Q-YW_xl17N98/view?usp=sharing", header=TRUE)


```

- `ls( )` and `names()` provide a list of variable names

```{r,linewidth = 80}
ls(d1) # List variable names #
names(d1)
```

- `head( )` shows the first six rows of your data

```{r}
head(d1) # Show first six rows #
```

- `dim( )` provides dimensions of your data frame

```{r,linewidth = 80}
dim(d1) # Number of rows and columns #
```


## Excel (.xlsx) file 

- Use the readxl package and `read_excel` function to access Excel files
  
- NOTE: I've added "eval = FALSE' to the R code below. It tells R not to evaluate these code. If you'd like to test the code, change it to "TRUE".
  
```{r, eval = FALSE}
install.packages("readxl", repos = 'http://cran.us.r-project.org')

library(readxl)

d2 <- read_excel("/Users/maroto/Dropbox/ Teaching/ SOC 456/ SOC 456 - FALL 20/ Lectures/ Week 3/ Data/cpss_series2.xlsx", 1)

ls(d2)
head(d2)
dim(d2)
```

## SPSS (.sav or .por) file

- Use the package "foreign" and the function `read.spss()` to import the data to R
  
```{r, eval = FALSE}
install.packages("foreign", repos = 'http://cran.us.r-project.org')

library(foreign)

d3 <- read.spss("/Users/maroto/Dropbox/ Teaching/ SOC 456/ SOC 456 - FALL 20/ Lectures/ Week 3/ Data/cpss_series2.sav", to.data.frame=TRUE)

ls(d3)
head(d3)
dim(d3)
```

## Stata (.dta) file

  - Use the "readstata13" library and then `read.dta13()` 
  - Older Stata files also work with the "foreign" package

  
```{r, eval = FALSE}
install.packages("readstata13", repos = 'http://cran.us.r-project.org')

library(readstata13)

d4 <- read.dta13("/Users/maroto/Dropbox/ Teaching/ SOC 456/ SOC 456 - FALL 20/ Lectures/ Week 3/ Data/cpss_series2.dta")

ls(d4)
head(d4)
dim(d4)
```


# 3. Wrangling Data

## Step \#1: Read the Codebook

- Take a look at the CPSS codebook

## Step \#2: Select and subset

- `subset()` creates a subset from the current data frame 

```{r, linewidth=100}
d2 <- subset(d1, 
             select = c(PUMFID, PERS_WGT, SEX, MARSTATC, PCHILD, PEDUC_LC, 
                        LM_30, PEMPSTC))
summary(d2)
```

- Write-out (export) data to a new file (for future use)

```{r, linewidth=100}
write.csv(d2, "cpss_series2_subset1.csv", 
          row.names = FALSE)
```

# Step \#3: Clean and tidy
    
- `summary()` provides min and max, mean, median, and first and third quartiles

```{r, linewidth=100}
summary(d2$MARSTATC)
```

- `table()` provides frequencies for values

```{r, linewidth=100}
table(d2$MARSTATC)
```

## Dealing with Missing Data in R

- Code LM_30 variable data as missing

```{r, linewidth=100}
table(d2$LM_30)
d2$LM_30_2 <- d2$LM_30 # Create new variable by copying old one
d2$LM_30_2[d2$LM_30 == 9] <- NA # Replace "9's" with NA 
table(d2$LM_30_2, useNA = "ifany")
summary(d2$LM_30_2)
```

- Code PEMPSTC variable data as missing

```{r, linewidth=100}
d2$PEMPSTC_2 <- d2$PEMPSTC # Create new variable by copying old one
d2$PEMPSTC_2[d2$PEMPSTC == 9] <- NA # Replace "9's" with NA 
table(d2$PEMPSTC_2, useNA = "ifany")
```
 
- Listwise deletion â€“ removing cases with missing data from our dataset

```{r}
d3 <- subset(d2, complete.cases(d2), drop=TRUE)
dim(d3)

write.csv(d3, "cpss_series2_subset2.csv", 
          row.names = FALSE)
```


# 4. Manipulating Data 

## Data and Variable Types (In R)

- use `typeof()` and `class()` to examine variables in R

```{r}
typeof(d3$LM_30)
class(d3$LM_30)

typeof(d3$PERS_WGT)
class(d3$PERS_WGT)
```

## Factor Variables 

- `as.factor( )` -- identifies vector components as categories    

```{r}
table(d3$MARSTATC) # First look at table 
is.factor(d3$MARSTATC) # Is it a factor?

d3$MARSTATC2 <- as.factor(d3$MARSTATC) # Copy other variable into new variable
is.factor(d3$MARSTATC2) # Is it a factor? 
```

- Using `recode()` function from package "car" 

```{r}
library(car)

d3$MARSTATC3 <- recode(d3$MARSTATC2, 
                       "1 = 'Married'; 
                       2 = 'Common-law'; 
                       3 = 'Formerly married'; 
                       4 = 'Never married'") 
table(d3$MARSTATC3)

```

## Indexing Variables

```{r}
d3$MARSTATC3[5] # element five #

d3$MARSTATC3[c(3, 5)] # elements 3, and 5 #

# can also create a vector to indicate which elements you want #

v <- c(1, 3, 5) 
d3$MARSTATC3[v]

d3$MARSTATC3[1:5] # can get a sequence of values #

```

## Conditional Selection

```{r, eval=FALSE}
d3$MARSTATC3[d3$SEX == 1] 

d3$MARSTATC3[d3$SEX == 1 & d3$PCHILD == 1] 

d3$MARSTATC3[d3$SEX == 1 & d3$PCHILD == 1 & d3$PEDUC_LC > 2] 
```

## Recoding Variables Using Indexing and Conditional Selection

```{r}
d3$MARSTATC4 <- NULL
d3$MARSTATC4 <- rep(0,length(d3$MARSTATC)) # Create variable of zeros
d3$MARSTATC4[d3$MARSTATC == 1] <- "Married"
d3$MARSTATC4[d3$MARSTATC == 2] <- "Common-law"
d3$MARSTATC4[d3$MARSTATC == 3] <- "Formerly married"
d3$MARSTATC4[d3$MARSTATC == 4] <- "Never married"
table(d3$MARSTATC4)
```

## Binary Variables

- Create a new variable indicating if person is employed (EMP) from employment status variable (PEMPSTC)

```{r}
d3$EMP <- rep(0,length(d3$PEMPSTC))
d3$EMP[d3$PEMPSTC < 4] <- 1
table(d3$EMP)

table(d3$EMP, d3$PEMPSTC)
```

## Naming and renaming variables

```{r}
i.tend.to.use.periods <- "This works"
some_people_prefer_snake_case <- "This works too"
otherPeopleUseCamelCase <- "This is good too"
aFew_People.RENOUNCEconvention <- "I don't recommend this"
```

## Quick Ways to Rename Variables

- Use the `rename()` function in the "dplyr" package

```{r, linewidth=80}
install.packages("dplyr", repos = 'http://cran.us.r-project.org')
library(dplyr)

names(d3)

d4 <- rename(d3, c(id = PUMFID, wgt = PERS_WGT,
                   sex = SEX, mar.stat1 = MARSTATC,
                   any.kids = PCHILD, educ = PEDUC_LC, 
                   lose.job = LM_30, emp.stat = PEMPSTC, 
                   lose.job2 = LM_30_2, emp.stat2 = PEMPSTC_2, 
                   mar.stat2 = MARSTATC2, mar.stat3 = MARSTATC3, 
                   mar.stat4 = MARSTATC4, emp = EMP))

names(d4)
```

## Saving Final Recoded Data

- Save a subset of data to work with

```{r, linewidth=100}
d5 <- subset(d4, select = c(id, wgt, sex, 
      mar.stat2, mar.stat3, any.kids, 
      educ, lose.job, emp.stat, emp), drop = TRUE)
dim(d5)

write.csv(d5, "cpss_series2_subset3.csv", 
          row.names = FALSE)
```

# Exercises

- Please go to the Week 3 Exercises for some problems to work on 


